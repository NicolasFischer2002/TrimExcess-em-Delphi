unit U_Principal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, System.Generics.Collections;

type
  TForm1 = class(TForm)
    Btn_TrimExcessExemplo: TButton;
    Btn_CarregarLista: TButton;
    Btn_TrimExcess: TButton;
    Lbl_Estado: TLabel;
    procedure Btn_TrimExcessExemploClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure Btn_CarregarListaClick(Sender: TObject);
    procedure Btn_TrimExcessClick(Sender: TObject);
  private
    { Private declarations }
    ListaInteirosPublica : TList<Integer>;
    procedure AcaoLblEstado(Left: Integer; Texto: String);
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

{
    Listas sempre alocam mais memória do que precisam, ou seja, sempre alocam 
 mais espaço do que estão usando. Isso ocorre para evitar o redimensionamento
 constante da estrutura, que ocasionaria em um custo maior de processamento.

    Para driblar esse uso excessivo de memória, após abastecer a lista e se 
 certificar de que a lista manterá este tamanho até o seu fim, pode ser utilizado
 um método conhecido como TrimExcess, para igualar o tamanho da lista com o 
 número de elementos dela.

    Este método - TrimExcess - é bastante útil em situações em que a lista 
 foi abastecida por completo ou teve seu tamanho setado de antemão, e após 
 isso itens foram removidos ou não adicionados a ponto de o número real de 
 itens não se aproximar da capacidade da lista, ocasionando em uma memória ociosa
 que pode ser liberada.
}

procedure TForm1.Btn_CarregarListaClick(Sender: TObject);
Var
   I : Integer;
begin
     // Adiciono 30 mil itens na lista para poder monitorar o crescimento
     // do exe na memória e poder comprar logo na sequência o quanto de memória
     // foi ganha com o TrimExcess
     for I := 0 to 29999 do
         ListaInteirosPublica.Add(I);

     AcaoLblEstado(79, 'Lista Carregada!');
end;

procedure TForm1.Btn_TrimExcessClick(Sender: TObject);
begin
     ListaInteirosPublica.Capacity := ListaInteirosPublica.Count;
     Lbl_Estado.Caption := 'TrimExcess aplicado!';
end;

procedure TForm1.Btn_TrimExcessExemploClick(Sender: TObject);
Var
   ListaInteiros     : TList<Integer>;
   CapacidadeInicial : Integer;
   CapacidadeFinal   : Integer;
   Comprimento       : Integer;
   I                 : Integer;
begin
     Try
        Try
           ListaInteiros := TList<Integer>.Create();

           // Abastecendo a lista
           for I := 1 to 2000 do
               ListaInteiros.Add(I);

           // O quanto de espaço que a lista alocou para evitar o
           // redimensionamento constante
           CapacidadeInicial  := ListaInteiros.Capacity;

           // O espaço real que a lista está ocupando
           Comprimento := ListaInteiros.Count;

           // Aplicando o TrimExcess
           // TrimExcess: remove o espaço extra não utilizado de uma lista
           ListaInteiros.Capacity := ListaInteiros.Count;
           CapacidadeFinal := ListaInteiros.Capacity;
        
        Except
          on Erro: Exception do
          ShowMessage('Erro inesperado: ' + Erro.Message);
        End;
     
     Finally
        FreeAndNil(ListaInteiros);
        ShowMessage('TrimExcess aplicado com sucesso! Espaço alocado antes do TrimExcess: '
                    + CapacidadeInicial.ToString() + ' Espaço alocado pós TrimExcess: '
                    + CapacidadeFinal.ToString());
     End;
end;

procedure TForm1.FormShow(Sender: TObject);
begin
     ListaInteirosPublica := TList<Integer>.Create();
end;

procedure TForm1.AcaoLblEstado(Left: Integer; Texto: String);
begin
     Lbl_Estado.Left    := Left;
     Lbl_Estado.Caption := Texto;
end;

end.
